
在一个严谨的量化系统中，**“基本面剔除 + 长短期夏普筛选”是极其重要的一环**。它是系统抵御“纯垃圾股连板炒作”崩溃风险的核心护城河。

需要将系统架构拆分为**双频共振**：
1. **低频池（月度/周频更新）**：执行 K-means聚类 + 基本面剔除后20% + 夏普选前50%，构建【高优核心板块池】。
2. **高频池（日频更新）**：对核心池内的板块执行阻力、资金、健康的 0-100 连续浮点数打分，生成日度交易信号。

---

# 📜 量化策略技术说明书 
**策略名称**：基于 K-means聚类与微观阻力打分的同花顺全量板块轮动系统
**基准标的**：中证全指 / 万得全A
**运行频率**：月度调仓（基本面底座） + 日频调仓（量价信号）
**系统架构**：双层过滤模型（Low-Freq Fundamental Filter + High-Freq Micro-structure Scoring）

---

## 模块一：底层数据字典与预处理 (Data Dictionary)
开发前需接入以下三类数据源，并对其做截面清洗（去极值、标准化）：

| 数据表类型 | 字段明细 (Fields) | 更新频率 | 用途 |
| :--- | :--- | :--- | :--- |
| **板块日线行情** | `Date, Sector_Code, Open, High, Low, Close, Volume, Amount` | 日频 | 计算高低价斜率、量能突变率 |
| **成分股映射** | `Date, Sector_Code, Stock_Code, Weight(权重)` | 日频 | 计算集中度、板块健康度 |
| **成分股财务与估值** | `Stock_Code, ROE_TTM, Rev_YoY(营收同比), PB, Total_Cap` | 日/季频 | 计算板块基本面得分 |

---

## 模块二：中低频底座——同类板块基本面与夏普优选
**触发频率**：每月最后交易日盘后运行。
**输出结果**：下个月的【核心交易板块池】（剔除垃圾概念，保留优质赛道）。

### 步骤 2.1：K-means++ 成分股聚类降维
*   **输入**：全市场 400+ 个同花顺板块的成分股权重向量。
*   **计算**：构建特征矩阵 $X$（行为板块，列为全市场个股，值为成分股权重）。
*   **算法**：调用 `K-means++` 算法，将板块划分为 $K=30$ 个大类（簇，Cluster）。
*   **目的**：将高度重合的概念（如“ChatGPT概念”、“AIGC概念”、“大模型概念”）归入同一簇，方便后续同类比较。

### 步骤 2.2：同类内部基本面负向剔除 (剔除后 20%)
针对每一个簇（Cluster）内的板块，计算以下三个基本面维度的**成分股加权值**：
1.  **集中度惩罚 (Concentration)**：
    *   计算前10大权重股的权重之和 $W_{top10}$。若等权，则看前十大市值股占比。
    *   *逻辑：权重过于集中代表极易受单一成分股暴雷影响，得分取负数。*
2.  **盈利能力 (Profitability)**：
    *   板块加权 $ROE = \sum (Weight_i \times ROE\_TTM_i)$
    *   板块加权营收增速 $Rev\_Growth = \sum (Weight_i \times Rev\_YoY_i)$
3.  **估值贡献度 (Valuation Contribution)**：
    *   拆解过去半年板块收益。计算板块整体的市净率变化率 $\Delta PB / PB_{0}$。
    *   估值贡献度 $= \frac{\Delta PB / PB_{0}}{\text{过去半年总涨幅}}$。数值越低越好（代表涨幅有真实的盈利支撑，而非纯拔估值炒作）。

**打分逻辑**：在每个簇内部，将上述指标进行标准化（Z-score）后等权相加，**直接剔除总分排名垫底的 20% 板块**。

### 步骤 2.3：高夏普优选 (选取前 50%)
在剔除了基本面最差的 20% 后，对剩余板块计算夏普比率：
1.  **近一年夏普比率** ($Sharpe_{1Y}$)
2.  **基期以来长期夏普比率** ($Sharpe_{All}$)
*   **逻辑**：在剩余板块中，根据长短期夏普综合排位，**保留排名前 50% 的板块**。
*   **最终输出**：经过聚类、基本面剔除、夏普优选后，全市场400个板块大约剩余 150 个，构成当月的**【核心观察池】**。

---

## 模块三：日频高精度浮点打分引擎 (Daily Scoring Engine)
**触发频率**：每日收盘后运行，也可以实时运行。
**运行范围**：仅对【核心观察池】内的约 150 个板块进行打分。

### 3.1 四大核心因子精细化计算公式

#### ① 趋势阻力因子 $Factor_{TR}$ (权重 40%)
*   获取近 20 个交易日的最⾼价序列 $H_t$ 与最低价序列 $L_t$。
*   作线性回归（$y = kx + b$）：
    *   $Slope_{High} = LinearRegression(H_t)$
    *   $Slope_{Low} = LinearRegression(L_t)$
*   **条件判定**：若 $Slope_{High} > 0$ 且 $Slope_{Low} > 0$，进入计算；否则因子值赋 0。
*   **公式**：$Factor_{TR} = \frac{\arctan(Slope_{High})}{\arctan(Slope_{Low})}$

#### ② 资金突变因子 $Factor_{Vol}$ (权重 30%)
*   **公式**：$Factor_{Vol} = \frac{\text{Mean}(Amount_{t-5 \to t})}{\text{Mean}(Amount_{t-20 \to t})}$
*   *逻辑：捕捉近期突然放量异动的板块。*

#### ③ 日频性价比因子 $Factor_{SR20}$ (权重 20%)
*   **公式**：$Factor_{SR20} = \frac{\text{Return}_{20D}}{\text{Volatility}_{20D}}$
*   *逻辑：惩罚近期暴涨暴跌、上蹿下跳的板块，奖励稳步主升浪。*

#### ④ 板块赚钱效应 $Factor_{Breadth}$ (权重 10%)
*   **公式**：$Factor_{Breadth} = \frac{\sum[Close_{i,t} > MA5_{i,t}]}{N_{total}} \times 100\%$
*   *逻辑：统计该板块内，有多少个股站在5日均线上，反应资金覆盖的广度。*

### 3.2 连续截面 ECDF 映射计算总分
设当日有效观测板块数量为 $M$。对于任意板块 $i$，获取其在上述四个因子中的绝对排名 $Rank_{k}$（升序排，数值越好名次越高，最高为 $M$）。
**板块总得分（精度保留2位小数）计算公式**：
$$Total\_Score_i = \left( \frac{Rank_{TR}}{M} \times 40 \right) + \left( \frac{Rank_{Vol}}{M} \times 30 \right) + \left( \frac{Rank_{SR20}}{M} \times 20 \right) + \left( \frac{Rank_{Breadth}}{M} \times 10 \right)$$

### 3.3 附加：一票否决风控惩罚 (Veto Penalty)
设风控乘数 $Penalty = 1.0$。若触发以下任一条件，直接令 $Total\_Score_i = 0$：
1. **破位断头铡**：近 5 日最低价局部线性回归斜率 $< 0$。
2. **极度边缘化**：当日板块成交额排在全市场后 10%。

---

## 模块四：系统执行与交易信号生成 (Signal & Execution)

### 4.1 信号生成阈值 (Hyper-parameters)
*   **买入线 ($Threshold_{Buy}$)**：90.0 分
*   **持有警戒线 ($Threshold_{Hold}$)**：70.0 分
*   **目标最大持仓 ($Max\_Pos$)**： 5 - 8 个板块

### 4.2 每日状态机流转 (State Machine)
**T日收盘后，执行以下逻辑链条，于 T+1 日早盘 09:30 执行交易：**

1.  **【卖出逻辑】(平仓旧标的)**
    遍历当前持仓账户内的板块。若满足以下其一，发出 `SELL_ALL` 指令：
    *   **破位止损**：当日 $Total\_Score_i == 0$。
    *   **热度衰竭**：当日 $Total\_Score_i < 70.0$。
    *   **簇内高低切**：该板块所在簇（Cluster）内，出现了另一个新板块得分 $\ge 90.0$，且新板块得分 $>$ 当前持仓得分 $+ 10.0$ 分（去弱留强）。

2.  **【买入逻辑】(开仓新标的)**
    若当前持仓数量 $< Max\_Pos$（账户有空余子弹）：
    *   在得分 $\ge 90.0$ 的板块池中，从高到低遍历。
    *   **聚类防重校验**：如果目标板块的 `Cluster_ID` 与当前账户内已有持仓的 `Cluster_ID` 相同，则**跳过该板块**（极度分散化，避免同概念重配）。
    *   发出 `BUY` 指令，直到填满持仓上限。

### 4.3 风险平价仓位管理 (Risk Parity Sizing)
不采用简单的等额资金买入（这会导致高波动的高新科技概念对账户净值影响过大），采用**基于20日历史波动率的倒数加权法**。

若当日确定持有 $K$ 个板块，设第 $j$ 个板块近20日年化波动率为 $\sigma_j$，则第 $i$ 个板块分配的资金权重为：
$$Weight_i = \frac{\frac{1}{\sigma_i}}{\sum_{j=1}^{K} \left( \frac{1}{\sigma_j} \right)}$$

*   *执行细节：若板块 $i$ 波动率高达60%，板块 $j$ 为30%，则分配给板块 $j$ 的资金将是板块 $i$ 的2倍。*

---

## 模块五：系统工程与回测建议 (Engineering & Backtesting)

### 5.1 数据表关联逻辑结构图
```text
(月底执行)                                            (每日执行)
[同花顺板块列表]                                       [昨日交易池持仓明细]
      │                                                     │
      ▼                                                     ▼
[K-means++ 聚类引擎] ────┐[高低价斜率回归引擎]
      │                 │                                   │
      ▼                 │                                   ▼[成分股财务/估值计算]   (生成)                           [量能与夏普计算器]
      │                 │                                   │
      ▼            [Cluster簇]                              ▼
[截面剔除底20%基本面]   (分组)[横截面 ECDF 排位]
      │                 │                                   │
      ▼                 │                                   ▼[选取前50%夏普比率] ─────┘[0-100分浮点打分引擎]
      │                                                     │
      ▼                                                     ▼
【下月度 核心观察池】 ─────────────────────────────────> 【交易信号过滤生成器】
      (共约 150 个优质板块)                                   │
                                                            ▼
                                                     [风险平价仓位计算器]
                                                            │
                                                            ▼
                                                     [生成 T+1 交易指令单]
```

### 5.2 排雷提示 (Caveats for Developers)
1. **多重共线性处理**：在做 K-means 聚类时，成分股向量极其稀疏，建议先采用 `TruncatedSVD` 或 `PCA` 降维到 50 维左右，再跑 K-means++，可大幅提升聚类稳定性和运算速度。
2. **ST股和新股污染**：在计算板块“集中度”和“赚钱效应”时，需要在底层数据代码中强行剔除 ST股、停牌股以及上市不满60天的新股，否则数据会产生严重的极值偏移。
3. **跳空缺口的斜率失真**：`np.polyfit` (线性回归) 遇到A股连续涨停的一字板会导致斜率极大。必须对价格序列取自然对数 $Ln(Price)$ 后再做回归，使斜率代表**真实的日均复合涨跌幅**，而非绝对价格变动。